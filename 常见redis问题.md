# 常见redis问题

### **1. 缓存雪崩（Cache Avalanche）**

**问题描述**：

大量缓存数据在同一时间**同时过期**或 Redis 实例**宕机**，导致所有请求直接打到数据库，引发数据库压力激增甚至崩溃。

**解决方案**：

- 

  **设置随机过期时间**：在原有过期时间上增加随机值，避免同时失效。

- 

  **热点数据永不过期**：对核心数据不设置过期时间，通过后台异步更新。

- 

  **多级缓存**：结合本地缓存（如 Caffeine）和分布式缓存（Redis）。

- 

  **高可用架构**：使用 Redis 集群（Cluster）或哨兵（Sentinel）保证服务可用性。

------

### **2. 缓存击穿（Cache Breakdown）**

**问题描述**：

某个**热点 key** 在过期瞬间，大量并发请求直接穿透到数据库，导致数据库瞬时压力过大。

**解决方案**：

- 

  **热点 key 永不过期**：通过后台异步更新缓存。

- 

  **互斥锁（Mutex）**：当缓存失效时，仅允许一个线程去加载数据，其他线程等待。

- 

  **使用逻辑过期**：在 value 中存储过期时间，业务逻辑判断是否需要异步更新。

------

### **3. 缓存穿透（Cache Penetration）**

**问题描述**：

大量请求查询**数据库中不存在的数据**（如恶意攻击），导致请求直接穿透到数据库。

**解决方案**：

- 

  **布隆过滤器（Bloom Filter）**：在缓存前加一层布隆过滤器，快速判断数据是否存在。

- 

  **空值缓存**：将查询为空的结果也缓存起来，并设置较短过期时间。

- 

  **接口层校验**：对请求参数进行合法性校验（如 ID≤0 直接拦截）。

------

### **4. 大 Key（Big Key）问题**

**问题描述**：

某个 key 存储的数据量过大（如一个 List 存储百万条数据），导致：

- 

  网络阻塞（传输耗时）。

- 

  内存不均，影响集群平衡。

- 

  操作耗时，阻塞其他请求。

**解决方案**：

- 

  **拆分大 Key**：将一个大 key 拆分为多个小 key。

- 

  **使用合适的数据结构**：如用 HyperLogLog 代替 Set 做基数统计。

- 

  **定期清理**：通过 `SCAN`命令扫描并清理大 Key。

------

### **5. 热 Key（Hot Key）问题**

**问题描述**：

某个 key 被高频访问，导致单一节点负载过高，可能成为性能瓶颈。

**解决方案**：

- 

  **本地缓存**：将热 key 缓存在应用服务器的本地内存中（需注意一致性）。

- 

  **读写分离**：通过主从复制，将读请求分散到多个从节点。

- 

  **Key 分片**：将热 key 拆分为多个子 key，分布到不同节点。

------

### **6. 数据一致性**

**问题描述**：

数据库与缓存数据不一致，常见于更新数据库后未同步更新或删除缓存。

**解决方案**：

- 

  **先更新数据库，再删除缓存**（Cache-Aside 模式）。

- 

  **使用延迟双删**：更新数据库后，删除缓存，延迟一小段时间后再删一次。

- 

  **基于消息队列的异步更新**：将缓存更新操作异步化，保证最终一致性。

------

### **7. 内存碎片化**

**问题描述**：

频繁的写入和删除操作导致内存碎片化，内存利用率下降。

**解决方案**：

- 

  **启用内存碎片整理**（Redis 4.0+ 支持 `activedefrag`）。

- 

  **控制 Key 的过期时间分散性**。

- 

  **使用 Jemalloc 内存分配器**。

------

### **8. 主从同步延迟**

**问题描述**：

主从节点之间数据同步存在延迟，可能导致读取到旧数据。

**解决方案**：

- 

  **监控同步偏移量**（`repl_backlog`和 `slave_repl_offset`）。

- 

  **业务层容忍度设计**：对一致性要求不高的数据才走从节点。

- 

  **使用 Redis Cluster**：将读写分散到多个主节点。

------

### **9. 持久化阻塞**

**问题描述**：

RDB 持久化时执行 `fork`操作可能阻塞主线程（尤其内存过大时），AOF 重写也会占用资源。

**解决方案**：

- 

  **使用混合持久化**（RDB+AOF，Redis 4.0+）。

- 

  **控制实例内存大小**（如单实例不超过 10GB）。

- 

  **在从节点进行持久化**，减少主节点压力。

------

### **10. 网络与连接问题**

**问题描述**：

客户端连接数过多、连接未复用、或网络延迟导致性能下降。

**解决方案**：

- 

  **使用连接池**（如 JedisPool、Lettuce）。

- 

  **合理设置超时时间**（`timeout`、`so_timeout`）。

- 

  **监控连接数**（`CLIENT LIST`），避免泄漏